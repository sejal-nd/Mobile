
skip_docs # skip autogenerating the README.md, we are manually writing it

import("Fastfile_Match")
import("Fastfile_Helpers")

default_platform(:ios)
  platform :ios do

    # MARK: Package IPA
    desc "Package and build the app, resulting in an IPA file"
    lane :build do |options|
      xcodes(
        version: "15.0.1",
        select_for_current_build_only: true
      )

      ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "8"
      
      build_app(
        project: "Mobile.xcodeproj",
        configuration: options[:configuration],
        scheme: options[:scheme],
        skip_package_dependencies_resolution: true,
        cloned_source_packages_path: "SourcePackages",
        silent: true,
        output_directory: options[:output_directory], # Destination directory. Defaults to current directory.
        output_name: "Mobile.ipa", # Specify the name of the .ipa file to generate (including file extension)
        export_method: "enterprise",
        export_options: {
          provisioningProfiles: {
            "com.exelon.mobile.ace.staging" => "ACE Staging Enterprise Dist",
            "com.exelon.mobile.bge.staging" => "BGE Staging Enterprise Dist",
            "com.exelon.mobile.comed.staging" => "ComEd Staging Enterprise Dist",
            "com.exelon.mobile.delmarva.staging" => "Delmarva Staging Enterprise Dist",
            "com.exelon.mobile.peco.staging" => "PECO Staging Enterprise Dist",
            "com.exelon.mobile.pepco.staging" => "Pepco Staging Enterprise Dist",

            "com.exelon.mobile.ace.staging.watchkitapp" => "ACE Staging Watchkit App Enterprise Dist",
            "com.exelon.mobile.bge.staging.watchkitapp" => "BGE Staging WatchKit App",
            "com.exelon.mobile.comed.staging.watchkitapp" => "ComEd Staging WatchKit App",
            "com.exelon.mobile.delmarva.staging.watchkitapp" => "Delmarva Staging WatchKit App",
            "com.exelon.mobile.peco.staging.watchkitapp" => "PECO Staging WatchKit App",
            "com.exelon.mobile.pepco.staging.watchkitapp" => "Pepco Staging WatchKit App"
          }
        }
      )

      # teams(
      #   title: "App Built Successfully",
      #   message: "App successfully builts!",
      #   facts:[
      #     {
      #      "name"=>"Platform",
      #      "value"=>"iOS"
      #     },
      #     {
      #       "name"=>"Lane Test",
      #       "value"=>"iOS Internal"
      #     }
      #   ],
      #   teams_url: "https://exeloncorp.webhook.office.com/webhookb2/50bbc509-81bb-4f27-9e1e-36c130782b82@600d01fc-055f-49c6-868f-3ecfcc791773/IncomingWebhook/98249b98175a4b4fbbe0b611c820c345/ee8c931d-feeb-44db-a23a-ddfe46e4a22d"
      # )
    end

    # Upload IPA to App Center
    desc "Upload a pre-built IPA and DSYM Zip to App Center and distribute"
    lane :app_center_upload do |options|
      appcenter_upload(
        api_token: options[:app_center_api_token],
        owner_name: "Exelon-Digital-Projects",
        owner_type: "organization",
        app_name: options[:app_name],
        file: options[:file_path],
        release_notes: sh("cat ReleaseNotes.md"),
        destinations: options[:destinations],
        dsym: options[:dsym_path]
      )
    end

    # Upload IPA to App Store
    desc "Upload a pre-built IPA to the App Store and tag release"
    lane :app_store_ipa_upload do |options|
      deliver(
        api_key_path: options[:api_key_path],
        app_identifier: options[:bundle_id],
        ipa: options[:ipa_path],
        metadata_path: options[:metadata_path],
        team_id: "YU7Y757VB5",
        submit_for_review: true,
        skip_screenshots: true,
        ignore_language_directory_validation: true,
        run_precheck_before_submit: false,
        precheck_include_in_app_purchases: false,
        submission_information: "{\"export_compliance_uses_encryption\": false, \"add_id_info_uses_idfa\": false }",
        force: true
      )

      tag_release

      # teams(
      #   title: "âœ… TODO OPCO NAME Successfully Uploaded to App Store",
      #   message: "App successfully builts!",
      #   facts:[
      #     {
      #      "name"=>"Platform",
      #      "value"=>"iOS"
      #     },
      #     {
      #       "name"=>"Lane Test",
      #       "value"=>"iOS Internal"
      #     }
      #   ],
      #   teams_url: "https://exeloncorp.webhook.office.com/webhookb2/50bbc509-81bb-4f27-9e1e-36c130782b82@600d01fc-055f-49c6-868f-3ecfcc791773/IncomingWebhook/98249b98175a4b4fbbe0b611c820c345/ee8c931d-feeb-44db-a23a-ddfe46e4a22d"
      # )
    end
  end
